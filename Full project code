#include <iostream>
#include <vector>
#include <map>
#include <fstream>
#include <ctime>
using namespace std;

class BankException : public exception
{
    string msg;

public:
    BankException(string m) { msg = m; }
    const char *what() const noexcept override
    {
        return msg.c_str();
    }
};

class Customer
{
    int id;
    string name;
    string address;
    string phone;
    string email;

public:
    Customer() {}

    Customer(int i, string n, string a, string p, string e)
    {
        id = i;
        name = n;
        address = a;
        phone = p;
        email = e;
    }

    int getId() { return id; }
    string getName() { return name; }

    void show()
    {
        cout << "\nCustomer ID: " << id;
        cout << "\nName: " << name;
        cout << "\nAddress: " << address;
        cout << "\nPhone: " << phone;
        cout << "\nEmail: " << email << endl;
    }

    string toFile()
    {
        return to_string(id) + "," + name + "," + address + "," + phone + "," + email;
    }
};

class Account
{
protected:
    string pin;
    int accNo;
    double balance;
    Customer *owner;
    string status;

public:
    Account(int no, Customer *c, string p)
    {
        accNo = no;
        owner = c;
        balance = 0;
        status = "Active";
        pin = p;
    }
    bool checkPin(string enteredPin)
    {
        return enteredPin == pin;
    }

    virtual ~Account() {}

    virtual void deposit(double amt)
    {
        if (amt <= 0)
            throw BankException("Amount must be positive.");
        balance += amt;
    }

    virtual void withdraw(double amt)
    {
        if (amt <= 0)
            throw BankException("Invalid amount.");
        if (amt > balance)
            throw BankException("Not enough balance.");
        balance -= amt;
    }

    int getAccNo() { return accNo; }
    double getBalance() { return balance; }
    Customer *getOwner() { return owner; }
    string getStatus() { return status; }

    void close() { status = "Closed"; }

    virtual string getType() = 0;

    virtual string toFile()
    {
        return to_string(accNo) + "," +
               to_string(balance) + "," +
               to_string(owner->getId()) + "," +
               status + "," +
               getType();
    }
};

class SavingsAccount : public Account
{
    double interest;

public:
    SavingsAccount(int no, Customer *c, string p)
        : Account(no, c, p)
    {
        interest = 0.05;
    }

    void applyInterest()
    {
        balance += balance * interest;
    }

    string getType() override
    {
        return "Savings";
    }
};

class CurrentAccount : public Account
{
    double minBalance;

public:
    CurrentAccount(int no, Customer *c, string p)
        : Account(no, c, p)
    {
        minBalance = 500;
    }

    void checkMinimum()
    {
        if (balance < minBalance)
            balance -= 50; 
    }

    string getType() override
    {
        return "Current";
    }
};

class Transaction
{
    int id;
    string type;
    double amount;
    int fromAcc;
    int toAcc;
    string date;

public:
    Transaction(int i, string t, double a, int f, int to)
    {
        id = i;
        type = t;
        amount = a;
        fromAcc = f;
        toAcc = to;

        time_t now = time(0);
        date = ctime(&now);
    }

    void show()
    {
        cout << "\nTransaction ID: " << id;
        cout << "\nType: " << type;
        cout << "\nAmount: " << amount;
        cout << "\nFrom: " << fromAcc;
        cout << "\nTo: " << toAcc;
        cout << "\nDate: " << date;
        cout << "---------------------------\n";
    }

    string toFile()
    {
        return to_string(id) + "," + type + "," +
               to_string(amount) + "," +
               to_string(fromAcc) + "," +
               to_string(toAcc) + "," + date;
    }
};

class Bank
{
    map<int, Customer> customerList;
    map<int, Account *> accountList;
    vector<Transaction> transList;
    int transId = 1;

public:
    void createCustomer()
    {
        int id;
        string name, addr, phone, email;

        cout << "\nEnter Customer ID: ";
        cin >> id;
        cin.ignore();

        cout << "Enter Name: ";
        getline(cin, name);

        cout << "Enter Address: ";
        getline(cin, addr);

        cout << "Enter Phone: ";
        getline(cin, phone);

        cout << "Enter Email: ";
        getline(cin, email);

        customerList[id] = Customer(id, name, addr, phone, email);
        cout << "Customer added successfully.\n";
    }

    void createAccount()
    {
        int accNo, custId, type;

        cout << "\nEnter Account Number: ";
        cin >> accNo;

        cout << "Enter Customer ID: ";
        cin >> custId;

        string pin;
        cout << "Set 4-digit PIN: ";
        cin >> pin;

        if (customerList.find(custId) == customerList.end())
            throw BankException("Customer does not exist.");

        cout << "1. Savings\n2. Current\nChoose: ";
        cin >> type;

        if (type == 1)
            accountList[accNo] = new SavingsAccount(accNo, &customerList[custId], pin);
        else
            accountList[accNo] = new CurrentAccount(accNo, &customerList[custId], pin);

        cout << "Account created.\n";
    }
    Account *loginUser(int accNo, string enteredPin)
    {

        if (accountList.find(accNo) == accountList.end())
            throw BankException("Account not found.");

        Account *acc = accountList[accNo];

        if (!acc->checkPin(enteredPin))
            throw BankException("Incorrect PIN.");

        return acc;
    }
    void transferFromLoggedIn(Account *sender, int destAcc, double amt)
    {

        if (accountList.find(destAcc) == accountList.end())
            throw BankException("Destination account not found.");

        sender->withdraw(amt);
        accountList[destAcc]->deposit(amt);

        transList.push_back(Transaction(transId++, "Transfer",
                                        amt,
                                        sender->getAccNo(),
                                        destAcc));
    }

    void depositFromLoggedIn(Account *acc, double amt)
    {
        acc->deposit(amt);
        transList.push_back(Transaction(transId++, "Deposit",
                                        amt,
                                        acc->getAccNo(),
                                        0));
    }

    void withdrawFromLoggedIn(Account *acc, double amt)
    {
        acc->withdraw(amt);
        transList.push_back(Transaction(transId++, "Withdraw",
                                        amt,
                                        acc->getAccNo(),
                                        0));
    }

    void depositMoney()
    {
        int accNo;
        double amt;

        cout << "\nAccount Number: ";
        cin >> accNo;

        cout << "Amount: ";
        cin >> amt;

        if (accountList.find(accNo) == accountList.end())
            throw BankException("Account not found.");

        accountList[accNo]->deposit(amt);

        transList.push_back(Transaction(transId++, "Deposit", amt, accNo, 0));
        cout << "Deposit successful.\n";
    }

    void withdrawMoney()
    {
        int accNo;
        double amt;

        cout << "\nAccount Number: ";
        cin >> accNo;

        cout << "Amount: ";
        cin >> amt;

        if (accountList.find(accNo) == accountList.end())
            throw BankException("Account not found.");

        accountList[accNo]->withdraw(amt);

        transList.push_back(Transaction(transId++, "Withdraw", amt, accNo, 0));
        cout << "Withdrawal successful.\n";
    }

    void transferMoney()
    {
        int from, to;
        double amt;

        cout << "\nFrom Account: ";
        cin >> from;

        cout << "To Account: ";
        cin >> to;

        cout << "Amount: ";
        cin >> amt;

        if (accountList.find(from) == accountList.end() ||
            accountList.find(to) == accountList.end())
            throw BankException("Invalid account number.");

        accountList[from]->withdraw(amt);
        accountList[to]->deposit(amt);

        transList.push_back(Transaction(transId++, "Transfer", amt, from, to));
        cout << "Transfer done.\n";
    }

    void showAccount()
    {
        int accNo;
        cout << "\nEnter Account Number: ";
        cin >> accNo;

        if (accountList.find(accNo) == accountList.end())
            throw BankException("Account not found.");

        Account *acc = accountList[accNo];

        cout << "\nAccount No: " << acc->getAccNo();
        cout << "\nOwner: " << acc->getOwner()->getName();
        cout << "\nBalance: " << acc->getBalance();
        cout << "\nStatus: " << acc->getStatus();
        cout << "\nType: " << acc->getType() << endl;
    }

    void showAllTransactions()
    {
        for (auto &t : transList)
            t.show();
    }

    void saveToFile()
    {
        ofstream cfile("customers.txt");
        for (auto &c : customerList)
            cfile << c.second.toFile() << endl;
        cfile.close();

        ofstream afile("accounts.txt");
        for (auto &a : accountList)
            afile << a.second->toFile() << endl;
        afile.close();

        ofstream tfile("transactions.txt");
        for (auto &t : transList)
            tfile << t.toFile() << endl;
        tfile.close();
    }
};

int main()
{
    Bank bank;
    int mainChoice;

    while (true)
    {
        cout << "\n======= Welcome To Banking System =======\n";
        cout << "1. Admin Login\n";
        cout << "2. User Login\n";
        cout << "3. Exit\n";
        cout << "Select: ";
        cin >> mainChoice;

        if (mainChoice == 1)
        {
            string password;
            cout << "\nEnter Admin Password: ";
            cin >> password;

            if (password != "admin123")
            {
                cout << "Wrong password!\n";
                continue;
            }

            int choice;
            while (true)
            {
                cout << "\n--- Admin Panel ---\n";
                cout << "1. Create Customer\n";
                cout << "2. Create Account\n";
                cout << "3. View Account\n";
                cout << "4. View All Transactions\n";
                cout << "5. Back to Main Menu\n";
                cout << "Choice: ";
                cin >> choice;

                try
                {
                    if (choice == 1)
                        bank.createCustomer();
                    else if (choice == 2)
                        bank.createAccount();
                    else if (choice == 3)
                        bank.showAccount();
                    else if (choice == 4)
                        bank.showAllTransactions();
                    else if (choice == 5)
                        break;
                    else
                        cout << "Invalid option.\n";
                }
                catch (exception &e)
                {
                    cout << "Error: " << e.what() << endl;
                }
            }
        }

        else if (mainChoice == 2)
        {

            int accNo;
            string pin;

            cout << "\nEnter Account Number: ";
            cin >> accNo;

            cout << "Enter PIN: ";
            cin >> pin;

            try
            {
                Account *loggedIn = bank.loginUser(accNo, pin);

                cout << "Login successful!\n";

                int choice;
                while (true)
                {
                    cout << "\n--- User Panel ---\n";
                    cout << "1. Deposit\n";
                    cout << "2. Withdraw\n";
                    cout << "3. Transfer\n";
                    cout << "4. View My Account\n";
                    cout << "5. Logout\n";
                    cout << "Choice: ";
                    cin >> choice;

                    if (choice == 1)
                    {
                        double amt;
                        cout << "Amount: ";
                        cin >> amt;
                        bank.depositFromLoggedIn(loggedIn, amt);
                        cout << "Deposit done.\n";
                    }
                    else if (choice == 2)
                    {
                        double amt;
                        cout << "Amount: ";
                        cin >> amt;
                        bank.withdrawFromLoggedIn(loggedIn, amt);
                        cout << "Withdraw done.\n";
                    }
                    else if (choice == 3)
                    {
                        int dest;
                        double amt;

                        cout << "Destination Account: ";
                        cin >> dest;

                        cout << "Amount: ";
                        cin >> amt;

                        bank.transferFromLoggedIn(loggedIn, dest, amt);

                        cout << "Transfer successful.\n";
                    }
                    else if (choice == 4)
                    {
                        cout << "\nAccount No: " << loggedIn->getAccNo();
                        cout << "\nBalance: " << loggedIn->getBalance();
                        cout << "\nType: " << loggedIn->getType() << endl;
                    }
                    else if (choice == 5)
                    {
                        cout << "Logging out...\n";
                        break;
                    }
                    else
                    {
                        cout << "Invalid choice.\n";
                    }
                }
            }
            catch (exception &e)
            {
                cout << "Login Failed: " << e.what() << endl;
            }
        }

        else if (mainChoice == 3)
        {
            bank.saveToFile();
            cout << "Data saved. System closing...\n";
            break;
        }

        else
        {
            cout << "Invalid choice.\n";
        }
    }

    return 0;
}
